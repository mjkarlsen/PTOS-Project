---
title: "MSDS Capstone Project"
author: "Matt Carlson"
date: "4/11/2020"
---

```{r, setup}

# devtools::install_github("markfairbanks/tidytable")

pacman::p_load( tidyverse, 
                fpp3, 
                lubridate, 
                DataExplorer, 
                janitor, 
                broom, 
                gt, 
                ggthemes,
                data.table,
                tidytable, 
                tictoc, 
                tidystringdist
                )

options(scipen=999)  #remove scientific notation
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.width = 12)
knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(echo = FALSE)

```

# Pennsylvania Trauma Outcome System

## Overview
There are many possible complications that can occur after injury and have surgical intervention. One of the major complications that can occur is compartment syndrome. CS typically develops 24-48 hours after surgery causing excessive fluid in the fascia causing pressure and pain in the affected limb. In as little as four hours the muscle can die and cause permanent damage. A treatment of compartment syndrome is a fasciotomy which relieves the pressure and maintains blood flow to the muscle.    

## Objective
There are two potential studies that could arrise out of this data set. One being focused on lower limb and the other on upper limbs. 


## Data Cleansing Process
* Patient Data
* Procedure


## Need
* Data Dictionary

#Analysis Steps
* Exploratory Data Analysis
* Data Manipulation

```{r load_data}

raw_data <- fread("E:/Northwestern/12 - Capstone/PTOS_Data.csv", na.strings = c("<unk>", "", "<n/a>")) %>%  
  as.data.table() %>% 
  clean_names()

icd_data <- fread("E:/Northwestern/12 - Capstone/ICD9_Data.csv") %>%  
  as.data.table() %>% 
  clean_names() %>% 
  mutate.(proc_code = as.character(proc_code)) %>% 
  select.(-org_proc_code)


injury_data <- fread("E:/Northwestern/12 - Capstone/ecode_data.csv") %>%  
  as.data.table() %>% 
  clean_names() %>% 
  mutate.(e_code = as.character(e_code)) %>% 
  select.(-diagnosis_code)

#AWS - 54.111 sec elapsed
#PC - 41.68 sec elapsed


```

## Drop Columns
Decided to remove any columns that only contain NA or NULL values to assist reducing the size of data. 

```{r drop_columns}

total_observations <- raw_data %>% summarize.(count = n.()) %>% as.integer()

complete_observations <- map_dfc.(raw_data, ~sum(is.na(.))) %>% 
  rename_with.(~ sub(".x", "", .x)) %>% 
  pivot_longer.(cols = everything.(), names_to = "column_names", values_to = "missings_obs") %>% 
  mutate.(total_missing = missings_obs/total_observations)

drop_column_list <- complete_observations %>% 
  filter.(total_missing >= 1) %>%  #drop columns that have no observations
  pull.(column_names) 

pto_df <- raw_data %>% 
  select.(-any_of.(drop_column_list)) %>%
  rename.(trauma_number = trauma_num, 
          dob = d_birth_a, 
          age = age_in_yrs, 
          injury_dt = inj_date_a, 
          injury_time = inj_time_a, 
          zip_code = pat_adr_z) %>% 
  filter.(!is.na(dob) & !is.na(age)) %>% 
  mutate.(dob = ifelse(is.na(dob), as.character(mdy(injury_dt)-years(age)), dob),
          age = ifelse(is.na(age) & !is.na(dob),
                       as.double(round(difftime(mdy(injury_dt), mdy(dob), unit="weeks")/52.25,0)),age),
          id = paste0(str_remove_all(dob, "/"), trauma_number)) %>% 
  relocate.(id, .before = alias_inst_num) %>% 
  filter.(age <= 16)

# FREE UP MEMORY AND DROP LARGE DATA 
rm("raw_data")
tidytable::inv_gc()

```


## Procedure Results
* looks like there is an issue with character type
```{r all_the_data}

column_details <- pto_df %>% 
  colnames() %>% 
  as_tidytable() %>% 
  arrange.(x) %>% 
  separate.(x, sep = "_", into = c("c1", "c2", "c3", "c4"), remove = FALSE)

procedures_df <- pto_df %>% 
  select.(id, starts_with.('proc_')) %>% 
  select.(id, 
          ends_with.('da'), 
          ends_with.('ta'), 
          ends_with.('pr'), 
          ends_with.('lc')) %>%  #may need to add location
  pivot_longer.(cols = -id,
                values_to = "values", 
                values_drop_na = TRUE) %>% 
  separate.(name, into = c("type", "serial", "desc"), sep = "_") %>% 
  pivot_wider.(., names_from = desc, values_from = values, values_fn = list) %>% 
  mutate.(date = mdy(da), 
          time = as.character(ta),
          date_time = ymd_hm(paste(date, time)),
          proc_code = as.character(pr), 
          loc_code = proc_loc_func(as.character(lc))
          ) %>% 
  select.(id, serial, date, time, date_time, loc_code, proc_code)

#ADD IN ICD 9 Descriptions
procedures_df <- procedures_df %>% 
  left_join.(icd_data, by = "proc_code")

# write_csv(procedures_df, "~/Data/procedures_info.csv")  
write_csv(procedures_df, "E:/Northwestern/12 - Capstone/procedures_info.csv")

```

```{r}
pto_df %>% 
  select.(id, trauma_number,  starts_with.('proc_')) %>% 
  filter.(trauma_number == '20031793'), 
## location of the procedure
## 32 complication is considered missed compartment syndrome

```



```{r patient_data}

source("01 - Classification Functions.R")

patient_df <- pto_df %>%
  select.(id,
          trauma_number,
          sex,
          dob,
          age,
          injury_dt,
          injury_time,
          inj_type,
          county_pa,
          zip_code,
          pay_cat1,
          pay_cat1_o,
          pay_cat2_o,
          weight_lb,
          weight_kg,
          temp_f,
          temp_c,
          hosp_days,
          e_code,
          pulse_a,
          resp_rat_a,
          sys_bp_a,
          discg_to_o,
          discg_to, 
          dis_status,
          race,
          extric_s,
          transp_s,
          drug_r_1,
          surg_sp,
          eye_opng_a,
          ver_resp_a,
          mot_resp_a, 
          hgt_fall, 
          #ref_ar_t_a ,  #time of arrival
          #eda_time_A

  ) %>%
  rename.(insurance_type = pay_cat1,
          insurance_1 = pay_cat1_o,
          insurance_2 = pay_cat2_o,
          discharge_status = dis_status,
          discharge_destination = discg_to,
          injury_type = inj_type,
          patient_extricated = extric_s,
          transportion = transp_s,
          drug_test = drug_r_1,
          attending_surgeon_spec = surg_sp,
          eye_resp = eye_opng_a,
          verbal_resp = ver_resp_a,
          motor_resp = mot_resp_a, 
          fall_height = hgt_fall
  ) %>%
  mutate.(dob = mdy(dob),
          injury_dt = mdy(injury_dt),
          e_code = as.character(e_code),
          #CASE STATEMENTS USING HELPER FUNCTIONS
          sex = gender_func(sex),
          race = race_func(race),
          injury_type = injury_func(injury_type),
          patient_extricated = extricated_func(patient_extricated),
          transportion = transportation_func(transportion),
          county_pa = county_func(county_pa),
          drug_test = drug_func(drug_test),
          attending_surgeon_spec = attending_surgeon_func(attending_surgeon_spec),
          eye_resp = eye_resp_func(eye_resp),
          verbal_resp = verbal_resp_func(verbal_resp),
          motor_resp = motor_resp_func(motor_resp), 
          insurance_type = insurance_func(insurance_type), 
          discharge_status = discharge_status_func(discharge_status), 
          discharge_destination = discharge_destination_func(discharge_destination), 
          age_range = age_range_func(age)
  )

patient_df <- patient_df %>% 
  left_join.(injury_data, by = c("e_code"))

# write_csv(procedures_df, "~/Data/procedures_info.csv")  
write_csv(patient_df, "E:/Northwestern/12 - Capstone/patient_info.csv")

```


```{r complication_data}

complication_df <-  pto_df %>% 
  filter.(complic_1 != 1) %>% 
  select.(id, starts_with.(c('complic_', 'comp_'))) %>% 
  pivot_longer.(cols = -id,
                values_to = "values", 
                values_drop_na = TRUE) %>% 
  separate.(name, into = c("type", "serial", "desc"), sep = "_") %>% 
  pivot_wider.(., names_from = desc, values_from = values, values_fn = list) %>% 
  mutate.(date = mdy(da), 
          proc_code = as.character(pr)) %>% 
  select.(id, serial, date, proc_code)

```



```{r}

procedures_df %>% 
  filter.(id == '0802199820031793') 


pat_list <- c('0802199820031793','1120200420151237','0516199820040445',
              '0223199920060813','0824199920060825','0727199920080462')
   

patient_df %>% 
  filter.(id %in% pat_list) %>%  
  t() %>% 
  view()

pto_df %>% 
  select(-starts_with(c("proc_", "burn_"))) %>% 
  filter.(id %in% pat_list) %>% 
  t() %>% 
  view()


select.(id, starts_with.('e_'))


icd_data %>% 
  


```




```{r column_similarity}
#https://github.com/ColinFay/tidystringdist

col_name_df <- tidy_comb_all(complete_observations, column_names)
col_name_similarity <- tidy_stringdist(col_name_df) #, method = c("osa", "lv","jw"))

col_names_grps <- col_name_similarity %>% 
  select(V1, V2, osa, lv, jw, soundex) %>% 
  mutate(str_match = str_extract(V2, stringr::str_sub(V1,1,4))) %>% 
  arrange(V1)


```

```{r group_like_columns}

set.seed(786)

library(stringdist)
1 - stringdist('edp05_a_ta','edp05_c_ta',method='jw',p=0.1)


a <- lapply(c("foo","bar","baz"),utf8ToInt)
seq_distmatrix(a)


a <- lapply(pto_df %>% colnames(), utf8ToInt)
b <- lapply(pto_df %>% colnames(), utf8ToInt)
seq_distmatrix(a, b)

pto_colnames <- pto_df %>% colnames() %>% as.data.table() %>% rename.("column_name" = ".")

pto_colnames


d <- stringdistmatrix(pto_df %>% colnames(), method = 'jw', p = 0.25)
plot(hclust(d))


columns_df_sc <- as.data.frame(scale(pto_colnames))
summary(columns_df_sc)

dist_mat <- dist(pto_colnames, method = 'euclidean')
hclust_avg <- hclust(dist_mat, method = 'average')
plot(hclust_avg)


stringdist(c('a','b','c'),c('a','c'))
stringdist(c('a','b','c'),c('a','c'))

```






```{r patient_info, paged.print=T}

pto_df %>% colnames()

patient_info <- pto_df %>% 
  select.(id, trauma_number, sex, dob, age, injury_dt, injury_time, county_pa, zip_code) %>% 
  mutate(dob = mdy(dob), 
         injury_dt = mdy(injury_dt), 
         sex = case.(sex == 1, "M",
                     sex == 2, "F"))
  
patient_info %>% 
  filter(id == '0101190119111')

write_csv(patient_info, "~/Data/patient_info.csv")  

```



# Exploratory Data Analysis

```{r}
pto_df %>% 
  head(100) %>% 
  glimpse()

pto_df %>% DataExplorer::plot_intro()

```

# Data Manipulation & Cleaning

## Consistent NA and NULL Values

```{r clean_null_na}

test_df <- pto_df %>% head(100)

test_df %>% 
  select.(is.character)
  mutate_all.(funs(str_replace(., "<NA>", "NA")))


```


```{r}

pto_df %>% select.(1:10) %>% head(10) %>% view()

```






```{r}

my_data %>% 
  select.(alias_inst_num, trauma_num, pat_adr_z, sex, ethnicity, raw_age) %>% 
  summarize.()

map.(my_data, ~sum(is.na(.)))




```

