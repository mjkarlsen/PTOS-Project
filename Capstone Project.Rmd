---
title: "MSDS Capstone Project"
author: "Matt Carlson"
date: "5/11/2020"
---

```{r, setup}

# devtools::install_github("markfairbanks/tidytable")
# devtools::install_github("ultramattyice/traumaR")
# devtools::install_github("r-lib/vctrs", INSTALL_opts = "--no-multiarch")

pacman::p_load( traumaR,
                tidytable,
                tidymodels,
                ggplot2, 
                ggthemes,
                rlang,
                forcats,
                tictoc, 
                gt, 
                vip, 
                yardstick)

options(scipen=999)  #remove scientific notation
knitr::opts_chunk$set(warning = FALSE, 
                      echo = FALSE)
# knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(fig.width = 12)
# knitr::opts_chunk$set(fig.height = 10)

```


## Load Multiple Data Sources
```{r load_data}

tic()

# raw_data <- fread("~/Data/PTOS_Data.csv", na.strings = c("<unk>", "", "<n/a>")) %>%
#   as.data.table() #%>%   clean_names()

raw_data <- fread("E:/Northwestern/12 - Capstone/PTOS_Data.csv", na.strings = c("<unk>", "", "<n/a>")) %>%
  as.data.table() #%>%   clean_names()

# 
# raw_data <- fread("E:/Northwestern/12 - Capstone/PTOS_Toy.csv", na.strings = c("<unk>", "", "<n/a>")) %>%  
#   as.data.table() #%>%   clean_names()

traumaR::run_full_show(raw_data)


toc()

tidytable::inv_gc()

#AWS - 230.08 sec elapsed
#PC  - 380.86 sec elapsed


##################################
# Save files into RData Frames
##################################

dfs<- list("patient_df", "patient_periods",  "ptos_df",  "trans_flat_df" , "trans_full_df")
file_path <- 'E:/Northwestern/12 - Capstone/PTOS_Data/'

for(d in dfs) {
    save(list=d, file=paste0(file_path,d, ".RData"))
}

##################################
# Load all processed RData Frames
##################################

for(d in dfs) {
    load(file = paste0(file_path,d, ".RData"))
}



```

# Exploratory Data Analysis

## What are the patient demographics that had forearm surgery and fasciotomy? 

```{r eda_1, fig.height=6, fig.width=8}

patient_col_list <- list('sex',   
                         'race',
                         'age_grp',
                         'discharge_status', 
                         'primary_injury_type',
                         'injury_desc', 
                         'place_of_injury',
                         'forearm_fx_loc',
                         'forearm_fx_desc',
                         'fasciotomy_loc'
)

bar_func <- function(data, col){

  col <- rlang::sym(col)

  graph_results <- data %>% 
    filter.(fltr_fasciotomy == T) %>% 
    summarize.(total = n.(), by = c(!!col, fltr_fasciotomy)) %>% 
    ggplot(aes(x = reorder(!!col, total), y =total, label = total)) +
    geom_bar(position = "dodge", stat = "identity") + 
    geom_text(vjust = 0)+
    ggthemes::theme_stata() +
    coord_flip() +
    labs(title = toupper(expr_text(col)),
         y = "Count of Patients",
         x = NULL) +
    theme(axis.text.y=element_text(angle=0, hjust=1)) +
    facet_wrap(~fltr_fasciotomy)
  
  return( graph_results)
}


map.(patient_col_list, ~ bar_func(patient_periods, .x))


# data.table::fwrite(patient_periods, file = "patient_time_periods.csv")

```


# Forearm Surgeries that results in Fasciotomy

```{r fasciotomy_results}

patient_df %>% 
  select.(forearm_fx_desc, fasciotomy_desc) %>% 
  filter.(!is.na(forearm_fx_desc)) %>% 
  mutate.(fasciotomy = ifelse.(is.na(fasciotomy_desc), 'no_fasc', 'yes_fasc')) %>% 
  summarize.(total = n.(), by = c(forearm_fx_desc, fasciotomy)) %>%
  arrange.(-total) %>% 
  pivot_wider.(names_from = fasciotomy, values_from = total) %>% 
  mutate.(total_no = no_fasc/sum(no_fasc, na.rm = TRUE), 
          total_yes = yes_fasc/sum(yes_fasc, na.rm = TRUE)) %>% 
  arrange.(-total_yes, forearm_fx_desc, ) %>% 
  select.(forearm_fx_desc, yes_fasc, total_yes, no_fasc, total_no) %>% 
  gt(
    rowname_col = 'forearm_fx_desc'
    ) %>% 
  tab_header(
    title = md("Forearm Procedures which have Fasciotomy"),
    subtitle = md("PTOS Data")
  ) %>% 
  tab_spanner(
    label = "Fasciotomy", 
    columns = vars(yes_fasc, total_yes)
  ) %>% 
  tab_spanner(
    label = "No Fasciotomy", 
    columns = vars(no_fasc, total_no)
  ) %>% 
  cols_label(yes_fasc = "#", 
             total_yes = "% of Total", 
             no_fasc = "#", 
             total_no = "% of Total") %>%
  fmt_percent(vars(total_yes, total_no), decimals = 1) %>% 
  fmt_number(vars(yes_fasc, no_fasc), decimals = 0) %>% 
  summary_rows(columns = vars( total_yes, total_no),
               fns = list(Total = ~sum(.)),
               formatter = fmt_percent,
               decimals = 1) %>%
  summary_rows(columns = vars(yes_fasc,  no_fasc),
               fns = list(Total = ~sum(.)),
               formatter = fmt_number,
               decimals = 0)
  
  
```

## Procedure Results by Forearm Surgeries

```{r proc}

fx_list <- patient_periods %>% 
  # filter.(fltr_procedure == T) %>% 
  select.(id, fltr_fasciotomy, fltr_procedure, sex, race, age_in_yrs, injury_desc) %>% 
  distinct.()

fx_proc <- trans_full_df %>% 
  mutate.(data_source = as_factor(data_source), 
          data_source = fct_relevel(data_source, c('arrival/discharge', 'diagnosis', 'procedure', 'complications' ))) %>% 
  inner_join.(fx_list, by = 'id')

data_quality_check <- data.table(procedures = fx_proc %>%  distinct.(id) %>% summarize.(cnt = n.()), 
                      patients = fx_list %>% summarize.(cnt = n.())) %>% 
  mutate.(diff = patients.cnt - procedures.cnt)

data_quality_check

tidytable::inv_gc()

fx_proc <- fx_proc %>% 
  arrange.(id, date, data_source, time ) %>% 
  filter.(data_source %notin% c('transport', 'arrival/discharge'))  %>% 
  mutate.(index = seq_len(.N), by = id ) %>% 
  select.(index, id, everything.()) 


fx_proc %>% 
  count(data_source) %>% 
  mutate(props = n/sum(n))


```


## Woe Binning
```{r}


library(woeBinning)

df <- fx_proc %>% 
  drop_na.() %>% 
  select(fltr_fasciotomy, subchapter_desc, injury_desc, code_desc) %>% 
  mutate(subchapter_desc = as.factor(subchapter_desc), 
         injury_desc = as.factor(injury_desc)) 

binning <- woe.tree.binning(df, 
                 target.var = 'fltr_fasciotomy', 
                 pred.var = 'subchapter_desc',  
                 event.class='TRUE')


woe.binning.plot(binning)
tabulate.binning <- woe.binning.table(binning)
tabulate.binning

```

## Using TidyModel FrameWork from Max Kuhn
* Need to bin the procedures together
* Need to bin the injuries together

```{r tidymodel_wf}

model_df <- fx_proc %>% 
  mutate.(fltr_fasciotomy = as_factor(fltr_fasciotomy),
          # date = lubridate::mdy(date), 
          # dow = as_factor(lubridate::wday(date, label = TRUE))
          ) %>%
  select.(-date, -time, -index, -code_desc, -code_cd, -id, -data_source, -chapter_desc, -fltr_procedure) %>% 
  as_tibble() %>% 
  na.omit() %>% 
  head(2000)


set.seed(123)
train_test_split <- rsample::initial_split(data = model_df, 
                                           strata = injury_desc)

train_df <- train_test_split %>% training() 
test_df  <- train_test_split %>% testing()

train_df %>% 
  count(loc_desc) %>% 
  mutate(props = n/sum(n))

test_df %>% 
  count(fltr_fasciotomy) %>% 
  mutate(props = n/sum(n))


set.seed(234)
val_set <- validation_split(train_df, 
                            strata = injury_desc,
                            prop = 0.80)
val_set

cores <- parallel::detectCores()-1

rf_mod <- 
  rand_forest(mtry = tune(), min_n = tune(), trees = 1000) %>% 
  set_engine("ranger", num.threads = cores) %>% 
  set_mode("classification")

rf_recipe <- 
  recipe(fltr_fasciotomy ~ ., data = train_df) %>%
  # check_missing(subchapter_desc, injury_desc ) %>% 
  # update_role(chapter_desc, fltr_procedure, new_role = 'ID' ) %>% 
  step_dummy(all_nominal(), -all_outcomes()) %>% 
  step_zv(all_predictors()) %>% 
  step_naomit(all_predictors()) %>% 
  step_novel(all_nominal()) %>% 
  step_modeimpute(all_nominal())

rf_workflow <- 
  workflow() %>% 
  add_model(rf_mod) %>% 
  add_recipe(rf_recipe)


rf_mod %>%    
  parameters()

set.seed(345)
rf_res <- 
  rf_workflow %>% 
  tune_grid(val_set,
            grid = 10,
            control = control_grid(save_pred = TRUE),
            metrics = metric_set(roc_auc))

rf_res %>% 
  show_best(metric = "roc_auc")

# autoplot(rf_res)


rf_best <- 
  rf_res %>% 
  select_best(metric = "roc_auc")

rf_auc <- 
  rf_res %>% 
  collect_predictions(parameters = rf_best) %>% 
  roc_curve(fltr_fasciotomy, .pred) %>% 
  mutate(model = "Random Forest")

rf_auc %>% 
# bind_rows(rf_auc, lr_auc) %>% 
  ggplot(aes(x = 1 - specificity, y = sensitivity, col = model)) + 
  geom_path(lwd = 1.5, alpha = 0.8) +
  geom_abline(lty = 3) + 
  coord_equal() + 
  scale_color_viridis_d(option = "plasma", end = .6)

```



```{r}

#TODO 
# 1. Only use patient data that has complete time and date for arrival, procedure, and fasciotomy
# 2. Use that to determine the typical time in between - it might be necessary to use the hosptial ID 
# 3. Use patients age, sex, and location
# 4. Build this into the traumaR functionality

create_patient_timeframe(patient_df)


time_frame_results <- 
patient_df %>% 
  filter.(fltr_fasciotomy == T, 
          fltr_procedure == T, 
          # age_in_yrs <= 16
  ) %>%
  # mutate_across.(ends_with.("_tm"), ~ ifelse.(is.na(.x), "12:00", .x)) %>% 
  mutate_across.(ends_with.("_tm"), as.ITime) %>% 
  mutate_across.(ends_with.("_dt"), mdy) %>% 
  # filter.(is.na(fasciotomy_tm)) %>%
  select.(
    id,
    age_in_yrs,
    arrival_dt,
    arrival_tm,
    forearm_fx_dt,
    forearm_fx_tm,
    fasciotomy_dt,
    fasciotomy_tm,
    discharge_dt,
    discharge_tm
  ) %>%
  drop_na.() %>% 
  mutate.(peds_adult = ifelse.(age_in_yrs <= 16, "Peds", "Adult"), 
          arrival_dtime = ymd_hms(paste(arrival_dt, arrival_tm)), 
          forearm_fx_dtime = ymd_hms(paste(forearm_fx_dt, forearm_fx_tm)), 
          fasciotomy_dtime = ymd_hms(paste(fasciotomy_dt, fasciotomy_tm)), 
          discharge_dtime = ymd_hms(paste(discharge_dt, discharge_tm)), 
          total_stay_time = as.period(interval(arrival_dtime,  discharge_dtime)), 
          arrival_to_forearm_time = as.period(interval(arrival_dtime, forearm_fx_dtime)), 
          arrival_to_fasciotomy_time = as.period(interval(arrival_dtime, fasciotomy_dtime)), 
          forearm_to_fasciotomy_time = as.period(interval(forearm_fx_dtime,  fasciotomy_dtime)), 
          fasciotomy_to_discharge_time = as.period(interval(fasciotomy_dtime,  discharge_dtime))) 


library(ggplot2)

time_frame_results %>% 
  ggplot(aes( x = period_to_seconds(total_stay_time), y = period_to_seconds(arrival_to_fasciotomy_time))) +
    geom_point()

time_frame_results %>% 
  mutate.(total_stay_sec = period_to_seconds(total_stay_time), 
          total_stay_sec = as.numeric(total_stay_sec)) %>%  
  ggplot(aes())
  hist(total_stay_sec, breaks=20)


time_frame_results %>% 
  mutate.(total_stay_sec = period_to_seconds(total_stay_time), 
          total_stay_sec = as.numeric(total_stay_sec)) %>%  
  ggplot(aes(x=total_stay_sec)) + 
  geom_histogram(color="black", fill="white")



time_frame_results %>% 
  mutate.(total_stay_sec = period_to_seconds(total_stay_time), 
          total_stay_min = total_stay_sec/60,
          total_stay_hr= total_stay_min/60, 
          total_stay_day = total_stay_hr/24)


p <- seconds(x = 120)

period_to_seconds(p)%/%60%/%60

geom_bar(position="dodge", stat="identity")


ggplot(data, aes(fill=condition, y=value, x=specie)) + 
    geom_bar(position="dodge", stat="identity")

```




