---
title: "MSDS Capstone Project"
author: "Matt Carlson"
date: "5/11/2020"
---

```{r, setup}

# devtools::install_github("markfairbanks/tidytable")
# devtools::install_github("ultramattyice/traumaR")

pacman::p_load( traumaR,
                tidytable,
                tidymodels,
                ggplot2, 
                ggthemes,
                rlang,
                tictoc, 
                gt)

options(scipen=999)  #remove scientific notation
knitr::opts_chunk$set(warning = FALSE, 
                      echo = FALSE)
# knitr::opts_chunk$set(message = FALSE)
# knitr::opts_chunk$set(fig.width = 12)
# knitr::opts_chunk$set(fig.height = 10)

```

## Load Multiple Data Sources
```{r load_data}

tic()

raw_data <- fread("~/Data/PTOS_Data.csv", na.strings = c("<unk>", "", "<n/a>")) %>%  
  as.data.table() #%>%   clean_names()

traumaR::run_full_show(raw_data)


toc()

#AWS - 230.028 sec elapsed
#PC -  sec elapsed


# procedures_test <- create_proc_df(ptos_df)


```

# Exploratory Data Analysis

## What are the patient demographics that had forearm surgery and fasciotomy? 

```{r eda_1, fig.height=6, fig.width=8}

patient_col_list <- list('sex',   
                         'race',
                         'age_grp',
                         'discharge_status', 
                         'primary_injury_type',
                         'place_of_injury',
                         'forearm_fx_loc',
                         'forearm_fx_desc',
                         'fasciotomy_loc'
)

bar_func <- function(data, col){

  col <- rlang::sym(col)

  graph_results <- data %>% 
    summarize.(total = n.(), by = c(!!col, fltr_fasciotomy)) %>% 
    ggplot(aes(x = reorder(!!col, total), y =total, label = total)) +
    geom_bar(position = "dodge", stat = "identity") + 
    geom_text(vjust = 0)+
    ggthemes::theme_stata() +
    coord_flip() +
    labs(title = toupper(expr_text(col)),
         y = "Count of Patients",
         x = NULL) +
    theme(axis.text.y=element_text(angle=0, hjust=1)) +
    facet_wrap(~fltr_fasciotomy)
  
  return( graph_results)
}


map.(patient_col_list, ~ bar_func(patient_periods, .x))


# data.table::fwrite(patient_periods, file = "patient_time_periods.csv")

```

## Predict Which Patients Will Have Fasciotomy

```{r}
patient_periods %>% summarize.(cnt = n.(), by = fltr_fasciotomy)

# Fltr_Fasciotomy will be my target variable
model_df <- patient_periods %>% 
  filter.(fltr_procedure == T) %>% 
  select.(fltr_fasciotomy,  
          everything.(), 
          -id, 
          -fasciotomy_loc, 
          -zip_code, 
          -ends_with.('_dt'), 
          -ends_with.('_tm'), 
          -ends_with.('_dtime')) %>% 
  mutate.(fltr_fasciotomy = as.factor(fltr_fasciotomy)) %>%
  mutate_across.(is.character, as.factor ) %>% 
  mutate_across.(is.period, hour) %>% 
  mutate_across.(is.double, ~ifelse.(is.na(.x), 0 , .x)) %>% 
  as_tibble()


# Create Test and Train Split on Data
set.seed(seed = 1972) 
train_test_split <- rsample::initial_split(data = model_df,     
                                           prop = 0.80)

train_df <- train_test_split %>% training() 
test_df  <- train_test_split %>% testing()

rec <-  recipe(fltr_fasciotomy ~ ., data = train_df) %>% 
  # step_string2factor(all_nominal()) %>% 
  step_dummy(all_nominal()) 

# Prepping
prepped <- rec %>% prep()

# Baking
train <- prepped %>%  juice()

test <- 
  prepped %>% 
  bake(new_data = test_df)

# ## Model specification
# rf_mod <- set_engine()
#   rand_forest(
#     mode = "classification",
#     trees = 200
#   )
# 
# # Fitting
# rf_fit <-
#   fit(
#     object = rf_mod,
#     formula = formula(prepped),
#     data = train,
#     engine = "randomForest"
#   )



rf_new <- rand_forest(mode = 'classification') %>% 
  set_engine('ranger', verbose = TRUE, importance = 'impurity', num.threads = 6) %>% 
  fit(fltr_fasciotomy ~ ., data = train_df)


rf_new

# rf_fit <- fit(fltr_fasciotomy ~ ., model = rf_mod, data = test_df)


```


```{r tidymodel_wf}

model_df <- patient_periods %>% 
  filter.(fltr_procedure == T) %>% 
  select.(fltr_fasciotomy,  
          everything.(), 
          -id, 
          -fasciotomy_loc, 
          -zip_code, 
          -ends_with.('_dt'), 
          -ends_with.('_tm'), 
          -ends_with.('_dtime'), 
          -ends_with.('_time')) %>% 
  mutate.(fltr_fasciotomy = as.factor(fltr_fasciotomy)) %>%
  mutate_across.(is.character, as.factor ) %>% 
  mutate_across.(is.period, hour) %>% 
  mutate_across.(is.double, ~ifelse.(is.na(.x), 0 , .x)) %>% 
  as_tibble()



# Create Test and Train Split on Data
set.seed(345)
train_test_split <- rsample::initial_split(data = model_df,     
                                           prop = 0.80)

train_df <- train_test_split %>% training() 
test_df  <- train_test_split %>% testing()

# Create Cross-Validation
folds <- vfold_cv(train_df, v = 10)

rf_mod <- rand_forest(mode = 'classification') %>% 
  set_engine('ranger', verbose = TRUE, importance = 'impurity', num.threads = 6)

# rf_wf <- 
#   workflow() %>%
#   add_model(rf_mod) %>%
#   add_formula(fltr_fasciotomy ~ .)
# 
# 
# set.seed(456)
# rf_fit_rs <- 
#   rf_wf %>% 
#   fit_resamples(folds)


rf_fit <- rf_mod %>% 
  fit(fltr_fasciotomy ~ ., data = train_df)

rf_training_pred <- 
  predict(rf_fit, train_df) %>% 
  bind_cols(predict(rf_fit, train_df, type = "prob")) %>% 
  # Add the true outcome data back in
  bind_cols(train_df %>% 
              select(fltr_fasciotomy))


rf_training_pred %>% 
  select(.pred_class, fltr_fasciotomy) %>%
  group_by(.pred_class, fltr_fasciotomy) %>% 
  summarize(cnt = n()) %>% 
  pivot_wider.(fltr_fasciotomy, cnt)


library(vip)
library(yardstick)

vip(rf_fit$fit, num_features = 40)

#Accuracy Results
rf_training_pred %>% metrics(fltr_fasciotomy, .pred_class) %>% 
  gt() 


```


```{r}

patient_df %>% 
  select.(forearm_fx_desc, fasciotomy_desc) %>% 
  filter.(!is.na(forearm_fx_desc)) %>% 
  mutate.(fasciotomy = ifelse.(is.na(fasciotomy_desc), 'no_fasc', 'yes_fasc')) %>% 
  summarize.(total = n.(), by = c(forearm_fx_desc, fasciotomy)) %>%
  arrange.(-total) %>% 
  pivot_wider.(names_from = fasciotomy, values_from = total) %>% 
  mutate.(total_no = no_fasc/sum(no_fasc, na.rm = TRUE), 
          total_yes = yes_fasc/sum(yes_fasc, na.rm = TRUE)) %>% 
  arrange.(-total_yes, forearm_fx_desc, ) %>% 
  select.(forearm_fx_desc, yes_fasc, total_yes, no_fasc, total_no) %>% 
  gt(
    rowname_col = 'forearm_fx_desc'
    ) %>% 
  tab_header(
    title = md("Forearm Procedures which have Fasciotomy"),
    subtitle = md("PTOS Data")
  ) %>% 
  tab_spanner(
    label = "Fasciotomy", 
    columns = vars(yes_fasc, total_yes)
  ) %>% 
  tab_spanner(
    label = "No Fasciotomy", 
    columns = vars(no_fasc, total_no)
  ) %>% 
  cols_label(yes_fasc = "#", 
             total_yes = "% of Total", 
             no_fasc = "#", 
             total_no = "% of Total") %>%
  fmt_percent(vars(total_yes, total_no), decimals = 1) %>% 
  fmt_number(vars(yes_fasc, no_fasc), decimals = 0) %>% 
  summary_rows(columns = vars( total_yes, total_no),
               fns = list(Total = ~sum(.)),
               formatter = fmt_percent,
               decimals = 1) %>%
  summary_rows(columns = vars(yes_fasc,  no_fasc),
               fns = list(Total = ~sum(.)),
               formatter = fmt_number,
               decimals = 0)
  
  
```



```{r}
ptos_df %>% 
  select.(id, starts_with.("ref_intd")) %>% 
  pivot_longer.(cols = -id) %>% 
  # drop_na.() %>% 
  # mutate.(inter_desc = ref_intd(value))
```


```{r}

patient_list <- patient_periods %>% select.(id) %>% pull.()

ptos_df %>% 
  filter.(id %in% patient_list) %>% 
  select.(id, starts_with.('ref_in')) %>% 
  pivot_longer.(cols = -id) %>% 
  filter.(!is.na(value)) %>% 
  mutate.(value = as.double(value))
```



```{r}

#TODO 
# 1. Only use patient data that has complete time and date for arrival, procedure, and fasciotomy
# 2. Use that to determine the typical time in between - it might be necessary to use the hosptial ID 
# 3. Use patients age, sex, and location
# 4. Build this into the traumaR functionality

create_patient_timeframe(patient_df)


time_frame_results <- 
patient_df %>% 
  filter.(fltr_fasciotomy == T, 
          fltr_procedure == T, 
          # age_in_yrs <= 16
  ) %>%
  # mutate_across.(ends_with.("_tm"), ~ ifelse.(is.na(.x), "12:00", .x)) %>% 
  mutate_across.(ends_with.("_tm"), as.ITime) %>% 
  mutate_across.(ends_with.("_dt"), mdy) %>% 
  # filter.(is.na(fasciotomy_tm)) %>%
  select.(
    id,
    age_in_yrs,
    arrival_dt,
    arrival_tm,
    forearm_fx_dt,
    forearm_fx_tm,
    fasciotomy_dt,
    fasciotomy_tm,
    discharge_dt,
    discharge_tm
  ) %>%
  drop_na.() %>% 
  mutate.(peds_adult = ifelse.(age_in_yrs <= 16, "Peds", "Adult"), 
          arrival_dtime = ymd_hms(paste(arrival_dt, arrival_tm)), 
          forearm_fx_dtime = ymd_hms(paste(forearm_fx_dt, forearm_fx_tm)), 
          fasciotomy_dtime = ymd_hms(paste(fasciotomy_dt, fasciotomy_tm)), 
          discharge_dtime = ymd_hms(paste(discharge_dt, discharge_tm)), 
          total_stay_time = as.period(interval(arrival_dtime,  discharge_dtime)), 
          arrival_to_forearm_time = as.period(interval(arrival_dtime, forearm_fx_dtime)), 
          arrival_to_fasciotomy_time = as.period(interval(arrival_dtime, fasciotomy_dtime)), 
          forearm_to_fasciotomy_time = as.period(interval(forearm_fx_dtime,  fasciotomy_dtime)), 
          fasciotomy_to_discharge_time = as.period(interval(fasciotomy_dtime,  discharge_dtime))) 


library(ggplot2)

time_frame_results %>% 
  ggplot(aes( x = period_to_seconds(total_stay_time), y = period_to_seconds(arrival_to_fasciotomy_time))) +
    geom_point()

time_frame_results %>% 
  mutate.(total_stay_sec = period_to_seconds(total_stay_time), 
          total_stay_sec = as.numeric(total_stay_sec)) %>%  
  ggplot(aes())
  hist(total_stay_sec, breaks=20)


time_frame_results %>% 
  mutate.(total_stay_sec = period_to_seconds(total_stay_time), 
          total_stay_sec = as.numeric(total_stay_sec)) %>%  
  ggplot(aes(x=total_stay_sec)) + 
  geom_histogram(color="black", fill="white")



time_frame_results %>% 
  mutate.(total_stay_sec = period_to_seconds(total_stay_time), 
          total_stay_min = total_stay_sec/60,
          total_stay_hr= total_stay_min/60, 
          total_stay_day = total_stay_hr/24)


p <- seconds(x = 120)

period_to_seconds(p)%/%60%/%60

geom_bar(position="dodge", stat="identity")


ggplot(data, aes(fill=condition, y=value, x=specie)) + 
    geom_bar(position="dodge", stat="identity")

```


```{r}

  trans_full_df %>%
    filter.(data_source %in% c('arrival', 'discharge', 'transport')) %>%   #, 'discharge', 'transport'
    select.(id, date, time, code_desc, data_source, loc_desc) %>% 
    filter.(date != 'NA') %>% 
    arrange.(id, date, time) %>% 
    pivot_wider.(names_from = code_desc, values_from = c(date, time), values_fn = max)
```


```{r data_for_analysis}

patient_df %>% 
  filter.(id == '0616196020000001') %>% t()
  filter.(fltr_fasciotomy == T)  %>% 
  t() 
 

```


```{r}

# 0101190120101353
ptos_df %>%  
  select.(id, starts_with.("ref_"), starts_with.("eda_")) %>% 
  filter.(id == '0101190120101353') %>% View()
```



```{r}
 

ptos_df %>% 
  select.(id, eda_time_a, eda_date_a, ref_ar_d_a, ref_ar_t_a, ref_dp_d_a, ref_dp_t_a, edl_date_a, edl_time_a) %>% head(100) %>% 
  # filter.(id == '0101190120101353') %>% 
  pivot_longer.(cols = -id) %>% 
  drop_na.() %>% 
  mutate.(type_col = ifelse.(str_detect(name, paste(c("date", "_d_"), collapse = '|')),'date', 'time'),
          code_desc = case.(name == 'eda_time_a', 'Arrival' ,
                          name == 'eda_date_a', 'Arrival' ,
                          name == 'ref_ar_d_a', "Arrival", 
                          name == 'ref_ar_t_a', "Arrival", 
                          name == 'ref_dp_d_a', "Discharge", 
                          name == 'ref_dp_t_a', "Discharge", 
                          name == 'edl_date_a', "Discharge", 
                          name == 'edl_time_a', "Discharge"),
          loc_desc = case.(name == 'eda_time_a', "ED", 
                           name == 'eda_date_a', "ED", 
                           name == 'ref_ar_d_a', "Referring Facility", 
                           name == 'ref_ar_t_a', "Referring Facility",
                           name == 'ref_dp_d_a', "Referring Facility", 
                           name == 'ref_dp_t_a', "Referring Facility", 
                           name == 'edl_date_a', "ED", 
                           name == 'edl_time_a', "ED")) %>% 
  select.(-name) %>% 
  pivot_wider.(names_from = type_col, values_from = value) %>% 
  mutate.(code_cd = "NA", 
          data_source = code_desc) %>% 
  select.(id, date, time, loc_desc, code_cd, code_desc, data_source)

        # arrival_time = ifelse(is.na(arrival_time), emergency_dpt_time, arrival_time),
        #   arrival_dt = ifelse(is.na(arrival_dt), emergency_dpt_dt, arrival_dt),
        #   
        #   eda_time_a #Emergency Department
        #   eda_date_a
        #   
        #   arrival_time = ref_ar_t_a, admission from referring hospital
        #   arrival_dt = ref_ar_d_a,
          
          #  'ref_dp_d_a',  'referring_facility_discharge_date',
          #  'ref_dp_d_d',  'referring_facility_discharge_dt',
          #  'ref_dp_t_a',  'referring_facility_discharge_tm',
          # 
          # 'edl_date_a',  'administratively_discharged_from_ed_date',
          # 'edl_date_d',  'administratively_discharged_from_ed_dt',

```

```{r}

ptos_df %>% 
  select.(id, starts_with.("pre_")) %>% head(100) %>% 
  # filter.(id == '0101190120101353') %>% 
  pivot_longer.(cols = -id) %>% 
  drop_na.() %>% 
  mutate.(type_col = ifelse.(str_detect(name, "_ta"),'time', 'date'), 
          loc_desc = case.(name == 'pre_1_a_da', 'transport arrive at scene',
                           name == 'pre_1_a_ta', 'transport arrive at scene',
                           name == 'pre_1_d_da', 'transport dispatch',
                           name == 'pre_1_d_ta', 'transport dispatch',
                           name == 'pre_1_l_da', 'transport leave scene',
                           name == 'pre_1_l_ta', 'transport leave scene',
                           name == 'pre_r_a_da', 'interhospital transport arrive at referring facility',
                           name == 'pre_r_a_ta', 'interhospital transport arrive at referring facility',
                           name == 'pre_r_d_da', 'interhospital transport dispatch',
                           name == 'pre_r_d_ta', 'interhospital transport dispatch',
                           name == 'pre_r_l_da', 'interhospital transport leave referring facility',
                           name == 'pre_r_l_ta', 'interhospital transport leave referring facility',
                           name == 'pre_s_a_da', 'scene provider arrive at scene',
                           name == 'pre_s_a_ta', 'scene provider arrive at scene',
                           name == 'pre_s_d_da', 'scene provider dispatch',
                           name == 'pre_s_d_ta', 'scene provider dispatch',
                           name == 'pre_s_l_da', 'scene provider leave scene',
                           name == 'pre_s_l_ta', 'scene provider leave scene'),
          code_desc = "transport") %>% 
  select.(-name) %>% 
  pivot_wider.(names_from = type_col, values_from = value) %>% 
  mutate.(code_cd = "NA", 
          data_source = code_desc) %>% 
  select.(id, date, time, loc_desc, code_cd, code_desc, data_source)


```



                       names == 'pre_1_a_da',  'arrive_at_scene',
                       names == 'pre_1_a_ta',  'arrive_at_scene',
                       names == 'pre_1_d_da',  'transport_dispatch',
                       names == 'pre_1_d_ta',  'transport_dispatch',
                       names == 'pre_1_l_da',  'transport_leave_scene',
                       names == 'pre_1_l_ta',  'transport_leave_scene',
                       names == 'pre_r_a_da',  'interhospital_transport_arrive_at_referring_facility',
                       names == 'pre_r_a_ta',  'interhospital_transport_arrive_at_referring_facility',
                       names == 'pre_r_d_da',  'interhospital_transport_dispatch',
                       names == 'pre_r_d_ta',  'interhospital_transport_dispatch',
                       names == 'pre_r_l_da',  'interhospital_transport_leave_referring_facility',
                       names == 'pre_r_l_ta',  'interhospital_transport_leave_referring_facility',
                       names == 'pre_s_a_da',  'scene_provider_arrive_at_scene',
                       names == 'pre_s_a_ta',  'scene_provider_arrive_at_scene',
                       names == 'pre_s_d_da',  'scene_provider_dispatch',
                       names == 'pre_s_d_ta',  'scene_provider_dispatch',
                       names == 'pre_s_l_da',  'scene_provider_leave_scene',
                       names == 'pre_s_l_ta',  'scene_provider_leave_scene',

