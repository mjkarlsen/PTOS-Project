---
title: "MSDS Capstone Project"
author: "Matt Carlson"
date: "4/11/2020"
---

```{r, setup}

# devtools::install_github("markfairbanks/tidytable")
# devtools::install_github("ultramattyice/traumaR")

pacman::p_load( traumaR,
                # tidytable, 
                # data.table, 
                janitor, 
                broom, 
                tidyverse, 
                fpp3, 
                lubridate, 
                DataExplorer, 
                gt, 
                ggthemes,
                tictoc 
                 
                # tidystringdist, 
)

options(scipen=999)  #remove scientific notation
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.width = 12)
knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(echo = FALSE)

```

# Data Preparation with traumaR
* Created a R Library called [traumaR](https://github.com/ultramattyice/traumaR) to consolidate all of the data manipulation 


## Drop Columns
Decided to remove any columns that only contain NA or NULL values to assist reducing the size of data. 

## Diagnosis Results
### Only pull results from Forearm Fractures


## Complications Results
### Only pull results from Forearm Fractures


```{r message=TRUE}

raw_data <- fread("E:/Northwestern/12 - Capstone/PTOS_Data_toy.csv", na.strings = c("<unk>", "", "<n/a>")) %>%  
  as.data.table() 

#example data for traumaR package
#data.table::fwrite(raw_data %>% head(30000), file = "E:/Northwestern/12 - Capstone/PTOS_Toy.csv")

traumaR::run_full_show(raw_data)

```

# Let's clean up the transactional data

```{r data_for_analysis, paged.print=TRUE}

trans_full_df %>% 
  filter.(id == '0616196020000001')

patient_df %>% 
  filter.(id == '0616196020000001')

```



```{r}
patient_df %>% 
  # filter.(fltr_procedure == T, 
  #         fltr_fasciotomy == T) %>%  
  select.(id, ends_with.("_dt"), starts_with.("fltr_")) %>% 
  filter.(id == '0616196020000001') 

```

```{r}
create_flat_test <- function(.full_trans) {

  forearm_surgery <- c('79.02', '79.12', '79.22', '79.32') #forearm surgery
  forearm_diag <- c(seq(from = 813.00, to = 813.99, by = 0.01)) #diagnosis for forearm fx

  .flat_trans <- .full_trans %>%
    filter.(data_source != 'injury') %>%
    summarize.(code_cd = paste(code_cd, collapse = " "),
               code_desc = paste(code_desc, collapse = ", "),
               by = c(id, data_source)
    ) %>%
    pivot_wider.(names_from = data_source,
                 values_from = c(code_cd, code_desc)) %>%
    drop_na.() %>%
    mutate.(fltr_diagnosis = (str_detect(code_cd_diagnosis, #diagnosis for forearm fx
                                            pattern = !!forearm_diag)),
            fltr_procedure = (str_detect(code_cd_procedure,
                                            pattern = !!forearm_surgery)),#forearm surgery
            fltr_complication = str_detect(code_cd_complication,
                                           pattern = '32'),
            fltr_fasciotomy = str_detect(code_cd_procedure,
                                         pattern = '83.14'))

  assign(paste("trans_flat_df_test"), data.frame(.flat_trans), envir = .GlobalEnv)
}

create_flat_test(trans_full_df)

trans_flat_df_test %>% 
    filter.(id == '0616196020000001') %>% 
  select.(id, ends_with.("_dt"), starts_with.("fltr_")) 


```





```{r}
trans_full_df %>% 
  filter.(id == '0616196020000001') %>% 
  create_flat_trans()


create_patient_df(ptos_df %>% 
                    filter.(id == '0616196020000001'), 
                  trans_flat_df %>%
                    filter.(id == '0616196020000001'), 
                  trans_full_df %>% 
                    filter.(id == '0616196020000001'))

patient_df
```





