---
title: "MSDS Capstone Project"
author: "Matt Carlson"
date: "4/11/2020"
---

```{r, setup}

# devtools::install_github("markfairbanks/tidytable")

pacman::p_load( tidyverse, 
                fpp3, 
                lubridate, 
                DataExplorer, 
                janitor, 
                broom, 
                gt, 
                ggthemes,
                data.table,
                tidytable, 
                tictoc, 
                tidystringdist
                )

options(scipen=999)  #remove scientific notation
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.width = 12)
knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(echo = FALSE)

```

# Pennsylvania Trauma Outcome System

## Overview
There are many possible complications that can occur after injury and have surgical intervention. One of the major complications that can occur is compartment syndrome. CS typically develops 24-48 hours after surgery causing excessive fluid in the fascia causing pressure and pain in the affected limb. In as little as four hours the muscle can die and cause permanent damage. A treatment of compartment syndrome is a fasciotomy which relieves the pressure and maintains blood flow to the muscle.    

## Objective
There are two potential studies that could arrise out of this data set. One being focused on lower limb and the other on upper limbs. 


## Data Cleansing Process
* Patient Data
* Procedure


## Need
* Data Dictionary

#Analysis Steps
* Exploratory Data Analysis
* Data Manipulation

```{r load_data}

tic()

raw_data <- fread("E:/Northwestern/12 - Capstone/PTOS_Data.csv", na.strings = c("<unk>", "", "<n/a>")) %>%  
  as.data.table() %>% 
  clean_names()

toc()


icd_data <- fread("E:/Northwestern/12 - Capstone/ICD9_Data.csv") %>%  
  as.data.table() %>% 
  clean_names() %>% 
  mutate.(proc_code = as.character(proc_code)) %>% 
  select.(-org_proc_code)


injury_data <- fread("E:/Northwestern/12 - Capstone/ecode_data.csv") %>%  
  as.data.table() %>% 
  clean_names() %>% 
  mutate.(e_code = as.character(e_code)) %>% 
  select.(-diagnosis_code)

#AWS - 54.111 sec elapsed
#PC - 41.68 sec elapsed


```

## Drop Columns
Decided to remove any columns that only contain NA or NULL values to assist reducing the size of data. 

```{r drop_columns}

total_observations <- raw_data %>% summarize.(count = n.()) %>% as.integer()

complete_observations <- map_dfc.(raw_data, ~sum(is.na(.))) %>% 
  rename_with.(~ sub(".x", "", .x)) %>% 
  pivot_longer.(cols = everything.(), names_to = "column_names", values_to = "missings_obs") %>% 
  mutate.(total_missing = missings_obs/total_observations)

drop_column_list <- complete_observations %>% 
  filter.(total_missing >= 1) %>%  #drop columns that have no observations
  pull.(column_names) 

pto_df <- raw_data %>% 
  select.(-any_of.(drop_column_list)) %>%
  rename.(trauma_number = trauma_num, 
          dob = d_birth_a, 
          age = age_in_yrs, 
          injury_dt = inj_date_a, 
          injury_time = inj_time_a, 
          zip_code = pat_adr_z) %>% 
  filter.(!is.na(dob) & !is.na(age)) %>% 
  mutate.(dob = ifelse(is.na(dob), as.character(mdy(injury_dt)-years(age)), dob),
          age = ifelse(is.na(age) & !is.na(dob),
                       as.double(round(difftime(mdy(injury_dt), mdy(dob), unit="weeks")/52.25,0)),age),
          id = paste0(str_remove_all(dob, "/"), trauma_number)) %>% 
  relocate.(id, .before = alias_inst_num)

# FREE UP MEMORY AND DROP LARGE DATA 
rm("raw_data")
tidytable::inv_gc()

```


## Procedure Results
* looks like there is an issue with character type
```{r all_the_data}

column_details <- pto_df %>% 
  colnames() %>% 
  as_tidytable() %>% 
  arrange.(x) %>% 
  separate.(x, sep = "_", into = c("c1", "c2", "c3", "c4"), remove = FALSE)

# column_details %>% view()

tic()

procedures_df <- pto_df %>% 
  select.(id, starts_with.('proc_')) %>% 
  select.(id, ends_with.(c('da', 'pr'))) %>% 
  #mutate_across.(ends_with.("_da"), lubridate::mdy) %>% 
  pivot_longer.(cols = -id,
                values_to = "values", 
                values_drop_na = TRUE) %>% 
  separate.(name, into = c("type", "serial", "desc"), sep = "_") %>% 
  pivot_wider.(., names_from = desc, values_from = values, values_fn = list) %>% 
  mutate.(date = mdy(da), 
         proc_code = as.character(pr)) %>% 
  select.(id, serial, date, proc_code)

#ADD IN ICD 9 Descriptions
procedures_df <- procedures_df %>% 
  left_join.(icd_data, by = "proc_code")

toc()

# write_csv(procedures_df, "~/Data/procedures_info.csv")  
write_csv(procedures_df, "E:/Northwestern/12 - Capstone/procedures_info.csv")


```


```{r patient_data}

patient_df <- pto_df %>% 
  select.(id, trauma_number, sex, dob, age, injury_dt, injury_time, inj_type, county_pa, zip_code, pay_cat1,
          pay_cat1_o, pay_cat2_o, weight_lb, weight_kg, temp_f, temp_c, hosp_days, e_code, pulse_a, resp_rat_a,
          sys_bp_a, discg_to_o, dis_status, race, extric_s, transp_s, drug_r_1, surg_sp, eye_opng_a, ver_resp_a) %>% 
  rename.(insurance_pay_category = pay_cat1, 
          insurance_1 = pay_cat1_o, 
          insurance_2 = pay_cat2_o, 
          discharge_status = dis_status, 
          injury_type = inj_type, 
          patient_extricated = extric_s, 
          transportion = transp_s, 
          drug_test = drug_r_1, 
          attending_surgeon_spec = surg_sp, 
          eye_opening_resp = eye_opng_a, 
          verbal_resp = ver_resp_a) %>% 
  mutate.(dob = mdy(dob), 
         injury_dt = mdy(injury_dt),
         e_code = as.character(e_code)) %>% 
  #CASE STATEMENTS
  mutate.(sex = case.(sex == 1, "M",
                     sex == 2, "F"), 
         race = case.(race == 1, "White",
                      race == 2, "Black",
                      race == 3, "Hispanic", 
                      race == 4, "Asian", 
                      race == 5, "Other", 
                      race == 'U', "Unknown" ), 
         injury_type = case.(injury_type == 1, "Blunt",
                             injury_type == 2, "Penetrating",
                             injury_type == 3, "Burn", 
                             injury_type == 4, "Skin Disease" ),
         patient_extricated = case.(patient_extricated == 1, "Yes", 
                                    patient_extricated == 2, "No"), 
         transportion = case.(transportion == 1, "Ambulance",
                              transportion == 2, "Helicopter",
                              transportion == 3, "Ambulance/Helicopter",
                              transportion == 4, "Police",
                              transportion == 5, "Fire Rescue",
                              transportion == 6, "Private Vehicle ",
                              transportion == 7, "Walk-In",
                              transportion == 8, "NA",
                              transportion == 9, "Quick Response Service",
                              transportion == 'U', "Unknown"), 
         county_pa = case.(county_pa ==1 , 'Adams',
                            county_pa ==2 , 'Allegheny',
                            county_pa ==3 , 'Armstrong',
                            county_pa ==4 , 'Beaver',
                            county_pa ==5 , 'Bedford',
                            county_pa ==6 , 'Berks',
                            county_pa ==7 , 'Blair',
                            county_pa ==8 , 'Bradford',
                            county_pa ==9 , 'Bucks',
                            county_pa ==10 , 'Butler',
                            county_pa ==11 , 'Cambria',
                            county_pa ==12 , 'Cameron',
                            county_pa ==13 , 'Carbon',
                            county_pa ==14 , 'Centre',
                            county_pa ==15 , 'Chester',
                            county_pa ==16 , 'Clarion',
                            county_pa ==17 , 'Clearfield',
                            county_pa ==18 , 'Clinton',
                            county_pa ==19 , 'Columbia',
                            county_pa ==20 , 'Crawford',
                            county_pa ==21 , 'Cumberland',
                            county_pa ==22 , 'Dauphin',
                            county_pa ==23 , 'Delaware',
                            county_pa ==24 , 'Elk',
                            county_pa ==25 , 'Erie',
                            county_pa ==26 , 'Fayette',
                            county_pa ==27 , 'Forest',
                            county_pa ==28 , 'Franklin',
                            county_pa ==29 , 'Fulton',
                            county_pa ==30 , 'Greene',
                            county_pa ==31 , 'Huntingdon',
                            county_pa ==32 , 'Indiana',
                            county_pa ==33 , 'Jefferson',
                            county_pa ==34 , 'Juniata',
                            county_pa ==35 , 'Lackawanna',
                            county_pa ==36 , 'Lancaster',
                            county_pa ==37 , 'Lawrence',
                            county_pa ==38 , 'Lebanon',
                            county_pa ==39 , 'Lehigh',
                            county_pa ==40 , 'Luzerne',
                            county_pa ==41 , 'Lycoming',
                            county_pa ==42 , 'McKean',
                            county_pa ==43 , 'Mercer',
                            county_pa ==44 , 'Mifflin',
                            county_pa ==45 , 'Monroe',
                            county_pa ==46 , 'Montgomery',
                            county_pa ==47 , 'Montour',
                            county_pa ==48 , 'Northampton',
                            county_pa ==49 , 'Northumberland',
                            county_pa ==50 , 'Perry',
                            county_pa ==51 , 'Philadelphia',
                            county_pa ==52 , 'Pike',
                            county_pa ==53 , 'Potter',
                            county_pa ==54 , 'Schuylkill',
                            county_pa ==55 , 'Snyder',
                            county_pa ==56 , 'Somerset',
                            county_pa ==57 , 'Sullivan',
                            county_pa ==58 , 'Susquehanna',
                            county_pa ==59 , 'Tioga',
                            county_pa ==60 , 'Union',
                            county_pa ==61 , 'Venango',
                            county_pa ==62 , 'Warren',
                            county_pa ==63 , 'Washington',
                            county_pa ==64 , 'Wayne',
                            county_pa ==65 , 'Westmoreland',
                            county_pa ==66 , 'Wyoming',
                            county_pa ==67 , 'York'), 
         drug_test = case.(drug_test == 0, "Not Tested",
                           drug_test == 1, "None",
                           drug_test == 2, "Cocaine",
                           drug_test == 3, "PCP",
                           drug_test == 4, "Benzodiazepines",
                           drug_test == 5, "Barbiturates",
                           drug_test == 6, "Narcotics",
                           drug_test == 7, "Amphetamines",
                           drug_test == 8, "Mariguana",
                           drug_test == 9, "Tricycloids"), 
         attending_surgeon_spec = case.(attending_surgeon_spec == 1, 'Trauma/General',
                                        attending_surgeon_spec == 2, 'Neurosurgery ',
                                        attending_surgeon_spec == 3, 'Orthopedic',
                                        attending_surgeon_spec == 4, 'Cardiac',
                                        attending_surgeon_spec == 5, 'OBGY',
                                        attending_surgeon_spec == 6, 'Ophthalmic',
                                        attending_surgeon_spec == 7, 'Oral/Maxillofacial',
                                        attending_surgeon_spec == 8, 'Otorhinolaryngologic',
                                        attending_surgeon_spec == 9, 'Pediatric',
                                        attending_surgeon_spec == 10, 'Plastic',
                                        attending_surgeon_spec == 11, 'Thoracic',
                                        attending_surgeon_spec == 12, 'Urologic',
                                        attending_surgeon_spec == 13, 'Burn',
                                        attending_surgeon_spec == 77, 'Other'), 
         eye_opening_resp = case.(eye_opening_resp == 1, "None",
                             eye_opening_resp == 2, "To Pain",
                             eye_opening_resp == 3, "To Voice",
                             eye_opening_resp == 4, "Spontaneous"), 
         verbal_resp = case.(verbal_resp == 1, "None",
                             verbal_resp == 2, "Incomprehensible Sounds",
                             verbal_resp == 3, "Inappropriate Words",
                             verbal_resp == 4, "Confused",
                             verbal_resp == 5, "Oriented",))



patient_df <- patient_df %>% 
  left_join.(injury_data, by = c("e_code"))


```



```{r}

procedures_df %>% 
  filter.(id == '0802199820031793') 


pat_list <- c('0802199820031793','1120200420151237','0516199820040445',
              '0223199920060813','0824199920060825','0727199920080462')
   

patient_df %>% 
  filter.(id %in% pat_list) %>%  
  t() %>% 
  view()

pto_df %>% 
  filter.(id %in% pat_list) %>% 
  t() %>% 
  view()


select.(id, starts_with.('e_'))


icd_data %>% 
  


```




```{r column_similarity}
#https://github.com/ColinFay/tidystringdist

col_name_df <- tidy_comb_all(complete_observations, column_names)
col_name_similarity <- tidy_stringdist(col_name_df) #, method = c("osa", "lv","jw"))

col_names_grps <- col_name_similarity %>% 
  select(V1, V2, osa, lv, jw, soundex) %>% 
  mutate(str_match = str_extract(V2, stringr::str_sub(V1,1,4))) %>% 
  arrange(V1)


```

```{r group_like_columns}

set.seed(786)

library(stringdist)
1 - stringdist('edp05_a_ta','edp05_c_ta',method='jw',p=0.1)


a <- lapply(c("foo","bar","baz"),utf8ToInt)
seq_distmatrix(a)


a <- lapply(pto_df %>% colnames(), utf8ToInt)
b <- lapply(pto_df %>% colnames(), utf8ToInt)
seq_distmatrix(a, b)

pto_colnames <- pto_df %>% colnames() %>% as.data.table() %>% rename.("column_name" = ".")

pto_colnames


d <- stringdistmatrix(pto_df %>% colnames(), method = 'jw', p = 0.25)
plot(hclust(d))


columns_df_sc <- as.data.frame(scale(pto_colnames))
summary(columns_df_sc)

dist_mat <- dist(pto_colnames, method = 'euclidean')
hclust_avg <- hclust(dist_mat, method = 'average')
plot(hclust_avg)


stringdist(c('a','b','c'),c('a','c'))
stringdist(c('a','b','c'),c('a','c'))

```






```{r patient_info, paged.print=T}

pto_df %>% colnames()

patient_info <- pto_df %>% 
  select.(id, trauma_number, sex, dob, age, injury_dt, injury_time, county_pa, zip_code) %>% 
  mutate(dob = mdy(dob), 
         injury_dt = mdy(injury_dt), 
         sex = case.(sex == 1, "M",
                     sex == 2, "F"))
  
patient_info %>% 
  filter(id == '0101190119111')

write_csv(patient_info, "~/Data/patient_info.csv")  

```



# Exploratory Data Analysis

```{r}
pto_df %>% 
  head(100) %>% 
  glimpse()

pto_df %>% DataExplorer::plot_intro()

```

# Data Manipulation & Cleaning

## Consistent NA and NULL Values

```{r clean_null_na}

test_df <- pto_df %>% head(100)

test_df %>% 
  select.(is.character)
  mutate_all.(funs(str_replace(., "<NA>", "NA")))


```


```{r}

pto_df %>% select.(1:10) %>% head(10) %>% view()

```






```{r}

my_data %>% 
  select.(alias_inst_num, trauma_num, pat_adr_z, sex, ethnicity, raw_age) %>% 
  summarize.()

map.(my_data, ~sum(is.na(.)))




```

