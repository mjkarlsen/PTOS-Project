---
title: "MSDS Capstone Project"
author: "Matt Carlson"
date: "4/11/2020"
---

```{r, setup}

# devtools::install_github("markfairbanks/tidytable")

pacman::p_load( tidyverse, 
                fpp3, 
                lubridate, 
                DataExplorer, 
                janitor, 
                broom, 
                gt, 
                ggthemes,
                data.table,
                tidytable, 
                tictoc, 
                tidystringdist
                )

options(scipen=999)  #remove scientific notation
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(fig.width = 12)
knitr::opts_chunk$set(fig.height = 10)
knitr::opts_chunk$set(echo = FALSE)

```

# Pennsylvania Trauma Outcome System

## Overview
There are many possible complications that can occur after injury and have surgical intervention. One of the major complications that can occur is compartment syndrome. CS typically develops 24-48 hours after surgery causing excessive fluid in the fascia causing pressure and pain in the affected limb. In as little as four hours the muscle can die and cause permanent damage. A treatment of compartment syndrome is a fasciotomy which relieves the pressure and maintains blood flow to the muscle.    

## Objective
There are two potential studies that could arrise out of this data set. One being focused on lower limb and the other on upper limbs. 


## Data Cleansing Process
* Patient Data
* Procedure


## Need
* Data Dictionary

#Analysis Steps
* Exploratory Data Analysis
* Data Manipulation

```{r load_data}

tic()

raw_data <- fread("E:/Northwestern/12 - Capstone/PTOS_Data.csv", na.strings = c("<unk>", "", "<n/a>")) %>%  
  as.data.table() %>% 
  clean_names()

toc()


icd_data <- fread("E:/Northwestern/12 - Capstone/ICD9_Data.csv") %>%  
  as.data.table() %>% 
  clean_names() %>% 
  mutate.(proc_code = as.character(proc_code)) %>% 
  select.(-org_proc_code)


injury_data <- fread("E:/Northwestern/12 - Capstone/ecode_data.csv") %>%  
  as.data.table() %>% 
  clean_names() %>% 
  mutate.(e_code = as.character(e_code)) %>% 
  select.(-diagnosis_code)

#AWS - 54.111 sec elapsed
#PC - 41.68 sec elapsed


```

## Drop Columns
Decided to remove any columns that only contain NA or NULL values to assist reducing the size of data. 

```{r drop_columns}

total_observations <- raw_data %>% summarize.(count = n.()) %>% as.integer()

complete_observations <- map_dfc.(raw_data, ~sum(is.na(.))) %>% 
  rename_with.(~ sub(".x", "", .x)) %>% 
  pivot_longer.(cols = everything.(), names_to = "column_names", values_to = "missings_obs") %>% 
  mutate.(total_missing = missings_obs/total_observations)

drop_column_list <- complete_observations %>% 
  filter.(total_missing >= 1) %>%  #drop columns that have no observations
  pull.(column_names) 

pto_df <- raw_data %>% 
  select.(-any_of.(drop_column_list)) %>%
  rename.(trauma_number = trauma_num, 
          dob = d_birth_a, 
          age = age_in_yrs, 
          injury_dt = inj_date_a, 
          injury_time = inj_time_a, 
          zip_code = pat_adr_z) %>% 
  filter.(!is.na(dob) & !is.na(age)) %>% 
  mutate.(dob = ifelse(is.na(dob), as.character(mdy(injury_dt)-years(age)), dob),
          age = ifelse(is.na(age) & !is.na(dob),
                       as.double(round(difftime(mdy(injury_dt), mdy(dob), unit="weeks")/52.25,0)),age),
          id = paste0(str_remove_all(dob, "/"), trauma_number)) %>% 
  relocate.(id, .before = alias_inst_num)

# FREE UP MEMORY AND DROP LARGE DATA 
rm("raw_data")
tidytable::inv_gc()

```


## Procedure Results
* looks like there is an issue with character type
```{r all_the_data}

column_details <- pto_df %>% 
  colnames() %>% 
  as_tidytable() %>% 
  arrange.(x) %>% 
  separate.(x, sep = "_", into = c("c1", "c2", "c3", "c4"), remove = FALSE)

# column_details %>% view()

tic()

procedures_df <- pto_df %>% 
  select.(id, starts_with.('proc_')) %>% 
  select.(id, ends_with.(c('da', 'pr'))) %>% 
  #mutate_across.(ends_with.("_da"), lubridate::mdy) %>% 
  pivot_longer.(cols = -id,
                values_to = "values", 
                values_drop_na = TRUE) %>% 
  separate.(name, into = c("type", "serial", "desc"), sep = "_") %>% 
  pivot_wider.(., names_from = desc, values_from = values, values_fn = list) %>% 
  mutate.(date = mdy(da), 
         proc_code = as.character(pr)) %>% 
  select.(id, serial, date, proc_code)

#ADD IN ICD 9 Descriptions
procedures_df <- procedures_df %>% 
  left_join.(icd_data, by = "proc_code")

toc()

# write_csv(procedures_df, "~/Data/procedures_info.csv")  
write_csv(procedures_df, "E:/Northwestern/12 - Capstone/procedures_info.csv")


```

```{r helper_functions}

gender_func <- function(col) {
  col_value <-  case.(col == 1, "M",
                      col == 2, "F",
                      default = "U")
  return(col_value)
}

race_func <- function(col) {
  col_value <-  case.(col == 1, "White",
                      col == 2, "Black",
                      col == 3, "Hispanic", 
                      col == 4, "Asian", 
                      col == 5, "Other", 
                      default = "Unknown")
  return(col_value)
}

county_func <- function(col) {
  col_value <- case.(col == 1 , 'Adams',
                     col == 2 , 'Allegheny',
                     col == 3 , 'Armstrong',
                     col == 4 , 'Beaver',
                     col == 5 , 'Bedford',
                     col == 6 , 'Berks',
                     col == 7 , 'Blair',
                     col == 8 , 'Bradford',
                     col == 9 , 'Bucks',
                     col == 10 , 'Butler',
                     col == 11 , 'Cambria',
                     col == 12 , 'Cameron',
                     col == 13 , 'Carbon',
                     col == 14 , 'Centre',
                     col == 15 , 'Chester',
                     col == 16 , 'Clarion',
                     col == 17 , 'Clearfield',
                     col == 18 , 'Clinton',
                     col == 19 , 'Columbia',
                     col == 20 , 'Crawford',
                     col == 21 , 'Cumberland',
                     col == 22 , 'Dauphin',
                     col == 23 , 'Delaware',
                     col == 24 , 'Elk',
                     col == 25 , 'Erie',
                     col == 26 , 'Fayette',
                     col == 27 , 'Forest',
                     col == 28 , 'Franklin',
                     col == 29 , 'Fulton',
                     col == 30 , 'Greene',
                     col == 31 , 'Huntingdon',
                     col == 32 , 'Indiana',
                     col == 33 , 'Jefferson',
                     col == 34 , 'Juniata',
                     col == 35 , 'Lackawanna',
                     col == 36 , 'Lancaster',
                     col == 37 , 'Lawrence',
                     col == 38 , 'Lebanon',
                     col == 39 , 'Lehigh',
                     col == 40 , 'Luzerne',
                     col == 41 , 'Lycoming',
                     col == 42 , 'McKean',
                     col == 43 , 'Mercer',
                     col == 44 , 'Mifflin',
                     col == 45 , 'Monroe',
                     col == 46 , 'Montgomery',
                     col == 47 , 'Montour',
                     col == 48 , 'Northampton',
                     col == 49 , 'Northumberland',
                     col == 50 , 'Perry',
                     col == 51 , 'Philadelphia',
                     col == 52 , 'Pike',
                     col == 53 , 'Potter',
                     col == 54 , 'Schuylkill',
                     col == 55 , 'Snyder',
                     col == 56 , 'Somerset',
                     col == 57 , 'Sullivan',
                     col == 58 , 'Susquehanna',
                     col == 59 , 'Tioga',
                     col == 60 , 'Union',
                     col == 61 , 'Venango',
                     col == 62 , 'Warren',
                     col == 63 , 'Washington',
                     col == 64 , 'Wayne',
                     col == 65 , 'Westmoreland',
                     col == 66 , 'Wyoming',
                     col == 67 , 'York', 
                     default = "Unknown")
  
  return(col_value)
}

injury_func <- function(col) {
  col_value <-  case.(col == 1, "Blunt",
                      col == 2, "Penetrating",
                      col == 3, "Burn", 
                      col == 4, "Skin Disease", 
                      default = "Unknown")
  return(col_value)
}

extricated_func <- function(col) {
  col_value <-  case.(col == 1, "Yes", 
                      col == 2, "No", 
                      default = "Unknown")
  return(col_value)
}

transportation_func <- function(col) {
  col_value <-  case.(col == 1, "Ambulance",
                      col == 2, "Helicopter",
                      col == 3, "Ambulance/Helicopter",
                      col == 4, "Police",
                      col == 5, "Fire Rescue",
                      col == 6, "Private Vehicle ",
                      col == 7, "Walk-In",
                      col == 8, "NA",
                      col == 9, "Quick Response Service",
                      default = "Unknown")
  return(col_value)
}

drug_func <- function(col) {
  col_value <-  case.(col == 0, "Not Tested",
                      col == 1, "None",
                      col == 2, "Cocaine",
                      col == 3, "PCP",
                      col == 4, "Benzodiazepines",
                      col == 5, "Barbiturates",
                      col == 6, "Narcotics",
                      col == 7, "Amphetamines",
                      col == 8, "Mariguana",
                      col == 9, "Tricycloids", 
                      default = "Unknown")
  return(col_value)
}

attending_surgeon_func <- function(col) {
  col_value <-  case.(col == 1, 'Trauma/General',
                      col == 2, 'Neurosurgery ',
                      col == 3, 'Orthopedic',
                      col == 4, 'Cardiac',
                      col == 5, 'OBGY',
                      col == 6, 'Ophthalmic',
                      col == 7, 'Oral/Maxillofacial',
                      col == 8, 'Otorhinolaryngologic',
                      col == 9, 'Pediatric',
                      col == 10, 'Plastic',
                      col == 11, 'Thoracic',
                      col == 12, 'Urologic',
                      col == 13, 'Burn',
                      col == 77, 'Other',
                      default = "Unknown")
  return(col_value)
}

eye_resp_func <- function(col) {
  col_value <-  case.(col == 1, "None",
                      col == 2, "To Pain",
                      col == 3, "To Voice",
                      col == 4, "Spontaneous",
                      default = "Unknown")
  return(col_value)
}

verbal_resp_func <- function(col) {
  col_value <-  case.(col == 1, "None",
                      col == 2, "Incomprehensible Sounds",
                      col == 3, "Inappropriate Words",
                      col == 4, "Confused",
                      col == 5, "Oriented", 
                      default = "Unknown")
  return(col_value)
}

motor_resp_func <- function(col) {
  col_value <-  case.(col == 1, "None",
                      col == 2, "Extension",
                      col == 3, "Flexion",
                      col == 4, "Withdraws",
                      col == 5, "Localizes pain",
                      col == 6, "Obeys Command", 
                      default = "Unknown")
  return(col_value)
}

```


```{r patient_data}

source("01 - Classification Functions.R")

patient_df <- pto_df %>%
  select.(id,
          trauma_number,
          sex,
          dob,
          age,
          injury_dt,
          injury_time,
          inj_type,
          county_pa,
          zip_code,
          pay_cat1,
          pay_cat1_o,
          pay_cat2_o,
          weight_lb,
          weight_kg,
          temp_f,
          temp_c,
          hosp_days,
          e_code,
          pulse_a,
          resp_rat_a,
          sys_bp_a,
          discg_to_o,
          dis_status,
          race,
          extric_s,
          transp_s,
          drug_r_1,
          surg_sp,
          eye_opng_a,
          ver_resp_a,
          mot_resp_a
  ) %>%
  rename.(insurance_pay_category = pay_cat1,
          insurance_1 = pay_cat1_o,
          insurance_2 = pay_cat2_o,
          discharge_status = dis_status,
          injury_type = inj_type,
          patient_extricated = extric_s,
          transportion = transp_s,
          drug_test = drug_r_1,
          attending_surgeon_spec = surg_sp,
          eye_resp = eye_opng_a,
          verbal_resp = ver_resp_a,
          motor_resp = mot_resp_a
  ) %>%
  mutate.(dob = mdy(dob),
          injury_dt = mdy(injury_dt),
          e_code = as.character(e_code),
          #CASE STATEMENTS USING HELPER FUNCTIONS
          sex = gender_func(sex),
          race = race_func(race),
          injury_type = injury_func(injury_type),
          patient_extricated = extricated_func(patient_extricated),
          transportion = transportation_func(transportion),
          county_pa = county_func(county_pa),
          drug_test = drug_func(drug_test),
          attending_surgeon_spec = attending_surgeon_func(attending_surgeon_spec),
          eye_resp = eye_resp_func(eye_resp),
          verbal_resp = verbal_resp_func(verbal_resp),
          motor_resp = motor_resp_func(motor_resp)
  )


patient_df <- patient_df %>% 
  left_join.(injury_data, by = c("e_code"))


```



```{r}

procedures_df %>% 
  filter.(id == '0802199820031793') 


pat_list <- c('0802199820031793','1120200420151237','0516199820040445',
              '0223199920060813','0824199920060825','0727199920080462')
   

patient_df %>% 
  filter.(id %in% pat_list) %>%  
  t() %>% 
  view()

pto_df %>% 
  filter.(id %in% pat_list) %>% 
  t() %>% 
  view()


select.(id, starts_with.('e_'))


icd_data %>% 
  


```




```{r column_similarity}
#https://github.com/ColinFay/tidystringdist

col_name_df <- tidy_comb_all(complete_observations, column_names)
col_name_similarity <- tidy_stringdist(col_name_df) #, method = c("osa", "lv","jw"))

col_names_grps <- col_name_similarity %>% 
  select(V1, V2, osa, lv, jw, soundex) %>% 
  mutate(str_match = str_extract(V2, stringr::str_sub(V1,1,4))) %>% 
  arrange(V1)


```

```{r group_like_columns}

set.seed(786)

library(stringdist)
1 - stringdist('edp05_a_ta','edp05_c_ta',method='jw',p=0.1)


a <- lapply(c("foo","bar","baz"),utf8ToInt)
seq_distmatrix(a)


a <- lapply(pto_df %>% colnames(), utf8ToInt)
b <- lapply(pto_df %>% colnames(), utf8ToInt)
seq_distmatrix(a, b)

pto_colnames <- pto_df %>% colnames() %>% as.data.table() %>% rename.("column_name" = ".")

pto_colnames


d <- stringdistmatrix(pto_df %>% colnames(), method = 'jw', p = 0.25)
plot(hclust(d))


columns_df_sc <- as.data.frame(scale(pto_colnames))
summary(columns_df_sc)

dist_mat <- dist(pto_colnames, method = 'euclidean')
hclust_avg <- hclust(dist_mat, method = 'average')
plot(hclust_avg)


stringdist(c('a','b','c'),c('a','c'))
stringdist(c('a','b','c'),c('a','c'))

```






```{r patient_info, paged.print=T}

pto_df %>% colnames()

patient_info <- pto_df %>% 
  select.(id, trauma_number, sex, dob, age, injury_dt, injury_time, county_pa, zip_code) %>% 
  mutate(dob = mdy(dob), 
         injury_dt = mdy(injury_dt), 
         sex = case.(sex == 1, "M",
                     sex == 2, "F"))
  
patient_info %>% 
  filter(id == '0101190119111')

write_csv(patient_info, "~/Data/patient_info.csv")  

```



# Exploratory Data Analysis

```{r}
pto_df %>% 
  head(100) %>% 
  glimpse()

pto_df %>% DataExplorer::plot_intro()

```

# Data Manipulation & Cleaning

## Consistent NA and NULL Values

```{r clean_null_na}

test_df <- pto_df %>% head(100)

test_df %>% 
  select.(is.character)
  mutate_all.(funs(str_replace(., "<NA>", "NA")))


```


```{r}

pto_df %>% select.(1:10) %>% head(10) %>% view()

```






```{r}

my_data %>% 
  select.(alias_inst_num, trauma_num, pat_adr_z, sex, ethnicity, raw_age) %>% 
  summarize.()

map.(my_data, ~sum(is.na(.)))




```

